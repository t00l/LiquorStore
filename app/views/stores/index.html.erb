<p id="notice"><%= notice %></p>

  <div id="demo">
  </div>

  <div class="map_container">
    <div id="DemoModal" class="reveal-modal" data-reveal aria-labelledby="firstModalTitle" aria-hidden="true" role="dialog">
        <div class="clasenombre"></div>
        <div class="clasehora"></div>
        <div class="claseimagen"></div>
        <div class="clasedireccion"></div>
        <button class="button round" id="target" >Trazar Ruta</button>
        <a class="close-reveal-modal" aria-label="Close">&#215;</a>
    </div>
    <div id="geolocation" class="geolocation"></div>
    <div class="reveal-modal-bg" style="display: none"></div>
  </div>

  <script src="//maps.google.com/maps/api/js?v=3.13&amp;sensor=false&amp;libraries=geometry" type="text/javascript"></script>

  <script src='//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js' type='text/javascript'></script>

  <script>

  


  var handler = Gmaps.build('Google');
  var current;

  function initialize(){

    handler.buildMap({ internal: {id: 'geolocation'} }, function() {
      
      markers_json = <%=raw @hash.to_json %>;
      markers = _.map(markers_json, function(marker_json){

        marker = handler.addMarker(marker_json);
        _.extend(marker, marker_json);

        return marker;
      });

      getLocation();

      markers.map(function(elem, index) {

        google.maps.event.addListener(elem.getServiceObject(), "click", function(evt) {

          var id = elem.store_id;
          var name = elem.store_name;
          var schedule = elem.store_schedule;
          var image = elem.store_image;
          var address = elem.store_address;
          var stars = elem.store_stars;

          var rate = elem.store_stars;
          console.log(rate);

          $(".clase").html("<h1><a href='stores/"+id+"'>"+name+" </a></h1>")


          $(".clasenombre").html("<h2>"+name+"</h2>")
          $(".clasehora").html("<h3>"+schedule+"</h3>")
          $(".claseimagen").html("<img src="+image+">")
          $(".clasedireccion").html("<p>"+address+"</p>")

          // $(document).foundation();
          // $('#DemoModal').modal('show');
          $('#DemoModal').foundation('reveal', 'open');


          
          // $('.modal-backdrop').removeClass("modal-backdrop");

          // $('#DemoModal').bind('closed', function() {
          //    console.log("myModal closed!");
          //  });
          // $(document).on('opened', '[data-reveal]', function () {
          //   debugger
          //   console.log('failed loading modal');
          // });

          // $('#DemoModal').on('hidden.bs.modal', function () {
          //   directionsDisplay.setMap(null);
          //   handler.map.centerOn(marker2);
          //   handler.getMap().setZoom(14);
          // })

          // $('#DemoModal').foundation('reveal', 'open', {
          //   success: function() {
          //       console.log('modal data loaded');
          //   },
          //   error: function() {
          //       console.log('failed loading modal');
          //   }
          // });
          // $("#DemoModal").reveal({ "closed": function () { alert("Good bye") } });

        //   $('#DemoModal').foundation('reveal', 'open', {

        //     success: function() {
        //         debugger
        //         alert('modal data loaded');
        //     },
        //     error: function() {
        //         alert('failed loading modal');
        //     }
        // });

        current = elem;

        });


      })

    });
    
  }

  function getLocation(){
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(displayOnMap);
    }
    else{
      navigator.geolocation.getCurrentPosition(displayOnMapError);
    }
  };

  // var markerLocation;

  function displayOnMap(position){
    
    marker2 = handler.addMarker({

      lat: position.coords.latitude,
      lng: position.coords.longitude,

      picture: {
          url: "<%= image_url('cat.png') %>",
          width:  36,
          height: 36
          },
      infowindow:  "aaa"
    });

    handler.map.centerOn(marker2);
    handler.getMap().setZoom(14);
  };

  function displayOnMapError(position){
    
    marker2 = handler.addMarker({

      lat: -33.469120,
      lng: -70.641997,

      picture: {
          url: "<%= image_url('cat.png') %>",
          width:  36,
          height: 36
          }
    });
    handler.map.centerOn(marker2);
    handler.getMap().setZoom(15);
  };



  var directionsDisplay = new google.maps.DirectionsRenderer();
  var directionsService = new google.maps.DirectionsService();

  function calcRoute(origin, destination) {
    // var origin      = new google.maps.LatLng(-33.469120, -70.641997);
    // var destination = new google.maps.LatLng(-33.589120, -70.761997);
    var request = {
        origin:      origin,
        destination: destination,
        travelMode:  google.maps.TravelMode.DRIVING
    };
    directionsService.route(request, function(response, status) {
      if (status == google.maps.DirectionsStatus.OK) {
        directionsDisplay.setDirections(response);
      }
    });
  }

  function showRoute(locationMarker, destinationMarker){
    currentLat = locationMarker.serviceObject.position.k;
    currentLng = locationMarker.serviceObject.position.D;
    var origin = new google.maps.LatLng(currentLat, currentLng);
    var destination = new google.maps.LatLng(destinationMarker.lat, destinationMarker.lng);

    calcRoute(origin, destination);
    directionsDisplay.setMap(handler.getMap());
  }

  initialize();


  </script>
  

<!-- <script>
$(document).ready(function(){
  $('.open-modal').click(function(){
    $('#DemoModal').modal('show');
    $('.modal-backdrop').removeClass("modal-backdrop");    
  }); 
});
</script> -->


<!-- Launch Button -->
<!-- <input type="button" class="btn btn-lg btn-primary open-modal" value="Launch Modal"> -->

<!-- Modal Contents -->
<!-- <div id="DemoModal" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
  
        <button type="button" class="close" data-dismiss="modal"
        aria-hidden="true">×</button>
  
        <h4 class="modal-title">Botilleria!!</h4>
      </div>
  
      <div class="modal-body">
        <p>Your software Version is Old, a new version of the software is available.</p>
        <p class="text-warning"><small>Would you like to download it now.</small></p>
        <div class="clase"></div>
        <div class="clase2"></div>
        <div class="clase3"></div>
        <div class="clase4"></div>
      </div>
  
      <div class="modal-footer">
        <button type="button" class="btn btn-default" id="target" >Trazar Ruta</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">Later</button>
      </div>
  
    </div>
  </div>
</div> -->

<!-- <a class="button" href="#" data-reveal-id="DemoModal">Inicia Sesión</a -->


<script>
  $(document).foundation();
  $(document).on('opened.fndtn.reveal', '[data-reveal]', function () {
    console.log("hola")
  });

  $(document).on('closed.fndtn.reveal', '[data-reveal]', function () {
    console.log("chao")
    directionsDisplay.setMap(null);
    handler.map.centerOn(marker2);
    handler.getMap().setZoom(14);
  });

  $( "#target" ).click(function() {
    showRoute(marker2, current);
  });

  // $('div').raty({ score: 3.26 });

</script>

<div>
  <h4>Comentarios</h4>
  <%= rating_for marker2, "rate"%>
</div>



